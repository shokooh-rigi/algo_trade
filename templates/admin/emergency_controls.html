{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}Emergency Controls{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; Emergency Controls
</div>
{% endblock %}

{% block content %}
<div class="module aligned">
    <h1>üö® Emergency Controls</h1>
    
    <div class="form-row">
        <div class="field-box">
            <h2>System Status</h2>
            <div class="status-indicator">
                {% if kill_switch_active %}
                    <span class="status-danger">üî¥ EMERGENCY STOP ACTIVE</span>
                {% else %}
                    <span class="status-success">üü¢ System Running</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="form-row">
        <div class="field-box">
            <h2>Active Components</h2>
            <ul>
                <li><strong>Active Strategies:</strong> {{ active_strategies }}</li>
                <li><strong>Active Deals:</strong> {{ active_deals }}</li>
            </ul>
        </div>
    </div>
    
    <div class="form-row">
        <div class="field-box">
            <h2>Emergency Actions</h2>
            
            {% if kill_switch_active %}
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="deactivate">
                    <button type="submit" class="button" style="background-color: #28a745; color: white;">
                        ‚úÖ Resume Trading
                    </button>
                </form>
            {% else %}
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="activate">
                    <button type="submit" class="button" style="background-color: #dc3545; color: white;"
                            onclick="return confirm('Are you sure you want to activate the emergency stop? This will halt ALL trading activities.')">
                        üö® Emergency Stop
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
    
    <div class="form-row">
        <div class="field-box">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <a href="{% url 'admin:algo_deal_changelist' %}" class="button">
                    üìä View All Deals
                </a>
                <a href="{% url 'admin:algo_strategyconfig_changelist' %}" class="button">
                    ‚öôÔ∏è Manage Strategies
                </a>
                <a href="{% url 'admin:algo_order_changelist' %}" class="button">
                    üìã View Orders
                </a>
            </div>
        </div>
    </div>
    
    <div class="form-row">
        <div class="field-box">
            <h2>System Health</h2>
            <div id="health-metrics">
                <p>Loading system metrics...</p>
            </div>
        </div>
    </div>
    
    <div class="form-row">
        <div class="field-box">
            <h2>Risk Dashboard</h2>
            <div id="risk-metrics">
                <p>Loading risk metrics...</p>
            </div>
        </div>
    </div>
</div>

<style>
.status-indicator {
    font-size: 18px;
    font-weight: bold;
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
}

.status-danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-buttons .button {
    padding: 10px 15px;
    text-decoration: none;
    border-radius: 4px;
    background-color: #007cba;
    color: white;
    border: none;
}

.action-buttons .button:hover {
    background-color: #005a87;
}

.field-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin: 10px 0;
}

.field-box h2 {
    margin-top: 0;
    color: #495057;
}
</style>

<script>
// Auto-refresh system metrics every 30 seconds
function loadSystemHealth() {
    fetch('{% url "admin:system_health" %}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('health-metrics').innerHTML = `
                <ul>
                    <li><strong>Total Deals:</strong> ${data.total_deals}</li>
                    <li><strong>Active Deals:</strong> ${data.active_deals}</li>
                    <li><strong>Total Orders:</strong> ${data.total_orders}</li>
                    <li><strong>Active Strategies:</strong> ${data.active_strategies}</li>
                </ul>
            `;
        })
        .catch(error => {
            document.getElementById('health-metrics').innerHTML = 
                '<p style="color: red;">Error loading system metrics</p>';
        });
}

function loadRiskMetrics() {
    fetch('{% url "admin:risk_dashboard" %}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('risk-metrics').innerHTML = `
                <ul>
                    <li><strong>Deals with Stop Loss:</strong> ${data.deals_with_stop_loss}</li>
                    <li><strong>Deals with Take Profit:</strong> ${data.deals_with_take_profit}</li>
                    <li><strong>Trailing Stops Active:</strong> ${data.trailing_stops_active}</li>
                </ul>
            `;
        })
        .catch(error => {
            document.getElementById('risk-metrics').innerHTML = 
                '<p style="color: red;">Error loading risk metrics</p>';
        });
}

// Load initial data
loadSystemHealth();
loadRiskMetrics();

// Set up auto-refresh
setInterval(loadSystemHealth, 30000);
setInterval(loadRiskMetrics, 30000);
</script>
{% endblock %}
